<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <style type="text/css">html {
        height: 100%
    }
    body {
        height: 100%;
        margin: 0;
        padding: 0
    }
    #container {
        height: 100%
    }
    #divStyle {
        width: 280px;
        height: 160px;
        border: solid 1px gray;
        display:block;
        margin: 2px 0;
        display:none;
    }
    #divStyle ul{
        list-style-type: none;
        padding: 2px 2px;
        margin: 2px 2px
    }
    #divStyle ul li a{
        cursor: pointer;
        margin: 2px 2px;
        width: 30px;
        height: 30px;
        display: inline-block;
        border: solid 1px #ffffff;
        text-align: center;
    }

    #divStyle ul li a:hover{
        background:none;
        border: solid 1px gray;
    }

    #divStyle ul li img{
        border: none;
        background:url('http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/icon.gif');
    }

    .common {
        font-size: 12px;
    }
    .star {
        color: #ff0000;
    }
    </style>
    <script src="http://cdn.bootcss.com/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=O1uMKSR3d1GHlmzxrMSvXbTWdRfrwUHR"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/MarkerTool/1.2/src/MarkerTool_min.js"></script>

    <title>历史轨迹</title>
</head>
<body>
<div style="width:100%;height: 700px;" id="container"></div>
<input type="button" value="选择标注样式" onclick="openStylePnl()" />
<input type="button" value="关闭" onclick="mkrTool.close()" />
<div id="divStyle" >
    <ul>
        <li>
            <a onclick="selectStyle(0)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:12px;height:21px;background-position: 0 0" /></a>
            <a onclick="selectStyle(1)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:12px;height:21px;background-position: -23px 0" /></a>
            <a onclick="selectStyle(2)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:12px;height:21px;background-position: -46px 0" /></a>
            <a onclick="selectStyle(3)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:12px;height:21px;background-position: -69px 0" /></a>
            <a onclick="selectStyle(4)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:12px;height:21px;background-position: -92px 0" /></a>
            <a onclick="selectStyle(5)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:12px;height:21px;background-position: -115px 0" /></a>
        </li>
        <li>
            <a onclick="selectStyle(6)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:19px;height:25px;background-position: 0 -21px" /></a>
            <a onclick="selectStyle(7)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:19px;height:25px;background-position: -23px -21px" /></a>
            <a onclick="selectStyle(8)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:19px;height:25px;background-position: -46px  -21px " /></a>
            <a onclick="selectStyle(9)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:19px;height:25px;background-position: -69px  -21px " /></a>
            <a onclick="selectStyle(10)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:19px;height:25px;background-position: -92px  -21px " /></a>
            <a onclick="selectStyle(11)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:19px;height:25px;background-position: -115px  -21px " /></a>
        </li>
        <li>
            <a onclick="selectStyle(12)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:17px;height:21px;background-position: 0 -46px " /></a>
            <a onclick="selectStyle(13)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:17px;height:21px;background-position: -23px  -46px " /></a>
            <a onclick="selectStyle(14)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:17px;height:21px;background-position: -46px  -46px " /></a>
            <a onclick="selectStyle(15)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:17px;height:21px;background-position: -69px  -46px " /></a>
            <a onclick="selectStyle(16)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:17px;height:21px;background-position: -92px  -46px " /></a>
            <a onclick="selectStyle(17)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:17px;height:21px;background-position: -115px  -46px " /></a>
        </li>
        <li>
            <a onclick="selectStyle(18)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:25px;height:25px;background-position: 0 -67px " /></a>
            <a onclick="selectStyle(19)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:25px;height:25px;background-position: -25px  -67px " /></a>
            <a onclick="selectStyle(20)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:25px;height:25px;background-position: -50px  -67px " /></a>
            <a onclick="selectStyle(21)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:25px;height:25px;background-position: -75px  -67px " /></a>
            <a onclick="selectStyle(22)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:25px;height:25px;background-position: -100px  -67px " /></a>
            <a onclick="selectStyle(23)" href = 'javascript:void(0)'><img src="http://api.map.baidu.com/library/MarkerTool/1.2/examples/images/transparent.gif" style="width:19px;height:25px;background-position: -125px  -67px " /></a>
        </li>
    </ul>
</div>
<script type="text/javascript">

    var opts = {
        width: 200,
        height: 100,
        title: "title",
        enableMessage: true,
        message: "信息"
    };
    var r = window.location.search;
    if (r.indexOf("?") > -1) {
        r = r.substring(r.indexOf("?") + 1, r.length);
    }
    var ajson = {
        "scale": 10,
        "center": "118.916812,32.109531",
        "coords": ["118.916812,32.109531", "120.444,32.515", "120.377065,31.488258", "120.530972,31.314192"],
        "infowindow":["地址:1","地址:2"],
        "repair":["120.945026,31.4149381","120.673666,31.161152","120.610425,31.287638","120.635722,31.420855","120.536261,31.393241","120.302271,31.552405","120.414379,31.598674","120.298246,31.586124"],
        "location":["地址:地址1</br>联系人:联系人1</br>联系电话:123456/<br/>备注",
            "地址:地址2</br>联系人:联系人2</br>联系电话:45232354<br/>备注",
            "地址:地址3</br>联系人:联系人3</br>联系电话:45252228<br/>备注",
            "地址:地址4</br>联系人:联系人4</br>联系电话:15875557<br/>备注",
            "地址:地址5</br>联系人:联系人5</br>联系电话:22725452<br/>备注",
            "地址:地址6</br>联系人:联系人6</br>联系电话:75272522<br/>备注",
            "地址:地址7</br>联系人:联系人7</br>联系电话:72725774<br/>备注",
            "地址:地址8</br>联系人:联系人8</br>联系电话:47416724<br/>备注"]
    };
    var map = new BMap.Map("container");
    map.enableScrollWheelZoom(true);
    var point = new BMap.Point(ajson.center.split(',')[0], ajson.center.split(',')[1]);
    map.centerAndZoom(point, ajson.scale);
    points = [];
    for (var j = 0; j < ajson.coords.length; j++) {
        var p1 = ajson.coords[j].split(",")[0];
        var p2 = ajson.coords[j].split(",")[1];
        points.push(new BMap.Point(p1, p2));
    }
    map.addOverlay(new BMap.Polyline(points, {strokeColor: "blue", strokeWeight: 3, strokeOpacity: 0.5}));
    var m1 = new BMap.Icon("image/marker.png", new BMap.Size(100,100), {
        offset: new BMap.Size(10, 25),
        imageOffset: new BMap.Size(0, 0 - 25)
    });
    var point1 = new BMap.Marker(points[0], {icon: m1});
    map.addOverlay(point1);
    //    point1.setAnimation(BMAP_ANIMATION_BOUNCE);
    point1.addEventListener("click", function(){
        map.openInfoWindow(new BMap.InfoWindow(ajson.infowindow[0], opts),point);
    });
    var mi = new BMap.Icon("image/marker.png", new BMap.Size(100,100), {
        offset: new BMap.Size(10, 25),
        imageOffset: new BMap.Size(0, 0 - 25)
    });
    var point2 = new BMap.Marker(points[points.length - 1], {icon: mi});
    map.addOverlay(point2);
    //    point2.setAnimation(BMAP_ANIMATION_BOUNCE);
    point2.addEventListener("click", function(){
        map.openInfoWindow(new BMap.InfoWindow(ajson.infowindow[1], opts),new BMap.Point(ajson.coords[points.length - 1].split(",")[0],ajson.coords[points.length - 1].split(",")[1]));
    });


    var menu = new BMap.ContextMenu();

    var txtMenuItem = [
        {
            text: '放大',
            callback: function () {
                map.zoomIn()
            }
        },
        {
            text: '缩小',
            callback: function () {
                map.zoomOut()
            }
        },
        {
            text:'在此添加标注',
            callback:function(p){
                var marker = new BMap.Marker(p);
                map.addOverlay(marker);
            }
        },
        {
            text: '编辑',
            callback: function () {
                window.open("json.html")
            }
        }
    ];
    for (var i = 0; i < txtMenuItem.length; i++) {
        menu.addItem(new BMap.MenuItem(txtMenuItem[i].text, txtMenuItem[i].callback, 100));
    }
    map.addContextMenu(menu);
    var navigationControl = new BMap.NavigationControl({
        anchor: BMAP_ANCHOR_TOP_LEFT,
        type: BMAP_NAVIGATION_CONTROL_LARGE,
        enableGeolocation: true
    });
    map.addControl(navigationControl);
    var geolocationControl = new BMap.GeolocationControl();
    geolocationControl.addEventListener("locationSuccess", function (e) {
        var address = '';
        address += e.addressComponent.province;
        address += e.addressComponent.city;
        address += e.addressComponent.district;
        address += e.addressComponent.street;
        address += e.addressComponent.streetNumber;
        alert("当前定位地址为：" + address);
    });
    geolocationControl.addEventListener("locationError", function (e) {
        alert(e.message);
    });
    map.addControl(geolocationControl);
    var repoints=[];
    for(var n=0;n<ajson.repair.length;n++) {
        repoints.push(new BMap.Point(ajson.repair[n].split(",")[0], ajson.repair[n].split(",")[1]));
    }

    var rm = new BMap.Icon("image/repair.png", new BMap.Size(45,45), {
        offset: new BMap.Size(-60, -60)
    });

    for (var m = 0; m < repoints.length; m++) {
        var this_point = new BMap.Marker(repoints[m], {icon: rm});
        map.addOverlay(this_point);
        this_point.Index = m;
        this_point.addEventListener("click", function (data) {
            var temp = new BMap.Point(data.target.point.lng, data.target.point.lat);
            map.openInfoWindow(new BMap.InfoWindow(ajson.location[data.target.Index], opts), temp);
        });
    }

</script>
</body>
</html>
<script type="text/javascript">
    //拼接infowindow内容字串
    var html = [];
    html.push('<span style="font-size:12px">属性信息: </span><br/>');
    html.push('<table border="0" cellpadding="1" cellspacing="1" >');
    html.push('  <tr>');
    html.push('      <td align="left" class="common">名 称：</td>');
    html.push('      <td colspan="2"><input type="text" maxlength="50" size="18"  id="txtName"></td>');
    html.push('	     <td valign="top"><span class="star">*</span></td>');
    html.push('  </tr>');
    html.push('  <tr>');
    html.push('      <td  align="left" class="common">电 话：</td>');
    html.push('      <td colspan="2"><input type="text" maxlength="30" size="18"  id="txtTel"></td>');
    html.push('	     <td valign="top"><span class="star">*</span></td>');
    html.push('  </tr>');
    html.push('  <tr>');
    html.push('      <td  align="left" class="common">地 址：</td>');
    html.push('      <td  colspan="2"><input type="text" maxlength="50" size="18"  id="txtAddr"></td>');
    html.push('	     <td valign="top"><span class="star">*</span></td>');
    html.push('  </tr>');
    html.push('  <tr>');
    html.push('      <td align="left" class="common">描 述：</td>');
    html.push('      <td colspan="2"><textarea rows="2" cols="15"  id="areaDesc"></textarea></td>');
    html.push('	     <td valign="top"></td>');
    html.push('  </tr>');
    html.push('  <tr>');
    html.push('	     <td  align="center" colspan="3">');
    html.push('          <input type="button" name="btnOK"  onclick="fnOK()" value="确定">&nbsp;&nbsp;');
    html.push('		     <input type="button" name="btnClear" onclick="fnClear();" value="重填">');
    html.push('	     </td>');
    html.push('  </tr>');
    html.push('</table>');

    var infoWin = new BMap.InfoWindow(html.join(""), {offset: new BMap.Size(0, -10)});
    var curMkr = null; // 记录当前添加的Mkr

    var mkrTool = new BMapLib.MarkerTool(map, {autoClose: true});
    mkrTool.addEventListener("markend", function(evt){
        var mkr = evt.marker;
        mkr.openInfoWindow(infoWin);
        curMkr = mkr;
    });

    //打开样式面板
    function openStylePnl(){
        document.getElementById("divStyle").style.display = "block";
    }

    //选择样式
    function selectStyle(index){
        mkrTool.open(); //打开工具
        var icon = BMapLib.MarkerTool.SYS_ICONS[index]; //设置工具样式，使用系统提供的样式BMapLib.MarkerTool.SYS_ICONS[0] -- BMapLib.MarkerTool.SYS_ICONS[23]
        mkrTool.setIcon(icon);
        document.getElementById("divStyle").style.display = "none";
    }

    //提交数据
    function fnOK(){
        var name = encodeHTML(document.getElementById("txtName").value);
        var tel = encodeHTML(document.getElementById("txtTel").value);
        var addr = encodeHTML(document.getElementById("txtAddr").value);
        var desc = encodeHTML(document.getElementById("areaDesc").value);

        if(!name || !tel || !addr){
            alert("星号字段必须填写");
            return;
        }

        if(curMkr){
            //设置label
            var lbl = new BMap.Label(name, {offset: new BMap.Size(1, 1)});
            lbl.setStyle({border: "solid 1px gray"});
            curMkr.setLabel(lbl);

            //设置title
            var title = "电话: " + tel + "\n\r" + "地址: " +addr + "\n\r" + "描述: " + desc;
            curMkr.setTitle(title);
        }
        if(infoWin.isOpen()){
            map.closeInfoWindow();
        }

        //在此用户可将数据提交到后台数据库中
    }

    //输入校验
    function encodeHTML(a){
        return a.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    //重填数据
    function fnClear(){
        document.getElementById("txtName").value = "";
        document.getElementById("txtTel").value = "";
        document.getElementById("txtAddr").value = "";
        document.getElementById("areaDesc").value = "";
    }
</script>
