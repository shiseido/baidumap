<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <style type="text/css">html {
        height: 100%
    }

    body {
        height: 100%;
        margin: 0;
        padding: 0
    }

    #container {
        height: 100%
    }</style>
    <script src="http://cdn.bootcss.com/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript"
            src="http://api.map.baidu.com/api?v=2.0&ak=O1uMKSR3d1GHlmzxrMSvXbTWdRfrwUHR"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/CurveLine/1.5/src/CurveLine.min.js"></script>
    <title>历史轨迹</title>
</head>
<body>
<div id="container" style="height: 100%"></div>
<script type="text/javascript">

    var opts = {
        width: 200,
        height: 100,
        title: "title",
        enableMessage: true,
        message: "信息"
    };
    var r = window.location.search;
    if (r.indexOf("?") > -1) {
        r = r.substring(r.indexOf("?") + 1, r.length);
    }
    var ajson = {
        "scale": 10,
        "center": "118.916812,32.109531",
        "coords": ["118.916812,32.109531", "120.444,32.515", "120.377065,31.488258", "120.530972,31.314192"],
        "infowindow":["地址:1","地址:2"],
        "repair":["120.945026,31.4149381","120.673666,31.161152","120.610425,31.287638","120.635722,31.420855","120.536261,31.393241","120.302271,31.552405","120.414379,31.598674","120.298246,31.586124"],
        "location":["地址:地址1</br>联系人:联系人1</br>联系电话:123456/<br/>备注",
            "地址:地址2</br>联系人:联系人2</br>联系电话:45232354<br/>备注",
            "地址:地址3</br>联系人:联系人3</br>联系电话:45252228<br/>备注",
            "地址:地址4</br>联系人:联系人4</br>联系电话:15875557<br/>备注",
            "地址:地址5</br>联系人:联系人5</br>联系电话:22725452<br/>备注",
            "地址:地址6</br>联系人:联系人6</br>联系电话:75272522<br/>备注",
            "地址:地址7</br>联系人:联系人7</br>联系电话:72725774<br/>备注",
            "地址:地址8</br>联系人:联系人8</br>联系电话:47416724<br/>备注"]
    };
    var map = new BMap.Map("container");
    map.enableScrollWheelZoom(true);
    var point = new BMap.Point(ajson.center.split(',')[0], ajson.center.split(',')[1]);
    map.centerAndZoom(point, ajson.scale);
    points = [];
    for (var j = 0; j < ajson.coords.length; j++) {
        var p1 = ajson.coords[j].split(",")[0];
        var p2 = ajson.coords[j].split(",")[1];
        points.push(new BMap.Point(p1, p2));
    }
    map.addOverlay(new BMap.Polyline(points, {strokeColor: "blue", strokeWeight: 3, strokeOpacity: 0.5}));
    var m1 = new BMap.Icon("image/marker.png", new BMap.Size(100,100), {
        offset: new BMap.Size(10, 25),
        imageOffset: new BMap.Size(0, 0 - 25)
    });
    var point1 = new BMap.Marker(points[0], {icon: m1});
    map.addOverlay(point1);
//    point1.setAnimation(BMAP_ANIMATION_BOUNCE);
    point1.addEventListener("click", function(){
        map.openInfoWindow(new BMap.InfoWindow(ajson.infowindow[0], opts),point);
    });
    var mi = new BMap.Icon("image/marker.png", new BMap.Size(100,100), {
        offset: new BMap.Size(10, 25),
        imageOffset: new BMap.Size(0, 0 - 25)
    });
    var point2 = new BMap.Marker(points[points.length - 1], {icon: mi});
    map.addOverlay(point2);
//    point2.setAnimation(BMAP_ANIMATION_BOUNCE);
    point2.addEventListener("click", function(){
        map.openInfoWindow(new BMap.InfoWindow(ajson.infowindow[1], opts),new BMap.Point(ajson.coords[points.length - 1].split(",")[0],ajson.coords[points.length - 1].split(",")[1]));
    });


    var menu = new BMap.ContextMenu();

    var txtMenuItem = [
        {
            text: '放大',
            callback: function () {
                map.zoomIn()
            }
        },
        {
            text: '缩小',
            callback: function () {
                map.zoomOut()
            }
        },
        {
            text:'在此添加标注',
            callback:function(p){
                var marker = new BMap.Marker(p);
                map.addOverlay(marker);
            }
        },
        {
            text: '编辑',
            callback: function () {
                window.open("json.html")
            }
        }
    ];
    for (var i = 0; i < txtMenuItem.length; i++) {
        menu.addItem(new BMap.MenuItem(txtMenuItem[i].text, txtMenuItem[i].callback, 100));
    }
    map.addContextMenu(menu);
    var navigationControl = new BMap.NavigationControl({
        anchor: BMAP_ANCHOR_TOP_LEFT,
        type: BMAP_NAVIGATION_CONTROL_LARGE,
        enableGeolocation: true
    });
    map.addControl(navigationControl);
    var geolocationControl = new BMap.GeolocationControl();
    geolocationControl.addEventListener("locationSuccess", function (e) {
        var address = '';
        address += e.addressComponent.province;
        address += e.addressComponent.city;
        address += e.addressComponent.district;
        address += e.addressComponent.street;
        address += e.addressComponent.streetNumber;
        alert("当前定位地址为：" + address);
    });
    geolocationControl.addEventListener("locationError", function (e) {
        alert(e.message);
    });
    map.addControl(geolocationControl);
    var repoints=[];
    for(var n=0;n<ajson.repair.length;n++) {
        repoints.push(new BMap.Point(ajson.repair[n].split(",")[0], ajson.repair[n].split(",")[1]));
    }
//        var repoint = new BMap.Point(ajson.repair[n].split(",")[0], ajson.repair[n].split(",")[1]);
        /*var reopts={
            offset: new BMap.Size(-60, -60),
            position: repoints
        };*/
    var rm = new BMap.Icon("image/repair.png", new BMap.Size(45,45), {
        offset: new BMap.Size(-60, -60)
    });
//        var myLabel = new BMap.Label("");

       /* myLabel.setStyle({
            fontSize: "14px",
            border: "0",
            height: "42px",
            width: "45px",
            textAlign: "center",
            lineHeight: "40px",
            background: "url(image/repair.png)",
            cursor: "pointer",
            color: "black"
        });
        myLabel.setTitle("维修站信息");*/
//    map.addOverlay(myLabel);
    for (var m = 0; m < repoints.length; m++) {
        var this_point = new BMap.Marker(repoints[m], {icon: rm});
        map.addOverlay(this_point);
        this_point.addEventListener("click", function (data) {
            var temp = new BMap.Point(data.point.lng, data.point.lat);
            map.openInfoWindow(new BMap.InfoWindow(ajson.location[0], opts), temp);
        });
    }
       /* map.addOverlay(myLabel);
            var repairinfoWindow = new BMap.InfoWindow(ajson.location[3],reopts,(new BMap.Point(ajson.repair[n].split(",")[0],ajson.repair[n].split(",")[1])));
            myLabel.addEventListener("click", function (data) {
                map.openInfoWindow(repairinfoWindow, repoint);
            });
    }*/
</script>
</body>
</html>
