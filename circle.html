<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="css/buttons.css"/>
    <style type="text/css">
        body, html{width: 100%;height: 100%;margin:0;font-size:22px;}
        #allmap{height:100%;width:100%;}
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=O1uMKSR3d1GHlmzxrMSvXbTWdRfrwUHR"></script>
    <title>电子栅栏</title>
    <script type="text/javascript" src="js/jquery.min.js"></script>
</head>
<body>
<div id="allmap" style="height: 100%"></div>
</body>
</html>
<script type="text/javascript">
    var r = window.location.search;
    if (r.indexOf("?") > -1) {
        r = r.substring(r.indexOf("?") + 1, r.length);
    }
    $.ajax({
        type: "Get",
        url: "GetCoords.json",
        data: r,
        dataType: "json",
        error: function (XMLHttpRequest, textStatus, errorThrown) {
            alert(XMLHttpRequest.responseText);
        },
        success: function (ajson) {
            var map = new BMap.Map("allmap");
            map.enableScrollWheelZoom(true);
            var point = new BMap.Point(ajson.center.split(',')[0], ajson.center.split(',')[1]);
            map.centerAndZoom(point, ajson.scale);
            points = [];
            for (var j = 0; j < ajson.coords.length; j++) {
                var p1 = ajson.coords[j].split(",")[0];
                var p2 = ajson.coords[j].split(",")[1];
                points.push(new BMap.Point(p1, p2));
            }
            map.addOverlay(new BMap.Polyline(points, {strokeColor: "blue", strokeWeight: 3, strokeOpacity: 0.5}));
            var m1 = new BMap.Icon("http://api.map.baidu.com/img/markers.png", new BMap.Size(23, 25), {
                offset: new BMap.Size(10, 25),
                imageOffset: new BMap.Size(0, 0 -25)
            });
            map.addOverlay(new BMap.Marker(points[0], {icon: m1}));
            var mi = new BMap.Icon("http://api.map.baidu.com/img/markers.png", new BMap.Size(23, 25), {
                offset: new BMap.Size(10, 25),
                imageOffset: new BMap.Size(0, 0 - 25)
            });
            map.addOverlay(new BMap.Marker(points[points.length - 1], {icon: mi}));

            /* var map = new BMap.Map("allmap");
             var point = new BMap.Point(ajson.center.split(',')[0], ajson.center.split(',')[1])
             map.centerAndZoom(point, 15);*/
            function ZoomControl(){
                this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
                this.defaultOffset = new BMap.Size(0, 0);
            }
            ZoomControl.prototype = new BMap.Control();
            ZoomControl.prototype.initialize = function(map){
                var div = document.createElement("button");
                div.appendChild(document.createTextNode("增加"));
                div.style.cursor = "pointer";
                div.style.border = "0px solid #dcdcdc";
                div.style.backgroundColor = "white";
                div.id="plus";
                div.style.fontSize="1rem";
                div.style.lineHeight="1.5rem";
                div.style.backgroundColor='#ededed';
                div.style.color="#ffffff";
                div.style.fontWeight="bold";
                div.style.fontFamily="Arial";
                div.style.background="-webkit-gradient(linear, left top, left bottom, color-start(0.05, #599bb3), color-stop(1, #408c99))";
                div.style.background='-moz-linear-gradient(top, #599bb3 5%, #408c99 100%)';
                div.style.background='-o-linear-gradient(top, #599bb3 5%, #408c99 100%)';
                div.style.background='-ms-linear-gradient(top, #599bb3 5%, #408c99 100%)';
                div.style.background='linear-gradient(to bottom, #599bb3 5%, #408c99 100%)';
                div.style.background='-webkit-linear-gradient(top, #599bb3 5%, #408c99 100%)';
                div.style.filter="'progid:DXImageTransform.Microsoft.gradient(startColorstr='#599bb3', endColorstr='#408c99',GradientType=0)'";
                div.style.webkitBorderTopLeftRadius='8px';
                div.style.mozBorderRadiusTopleft='8px';
                div.style.borderTopLeftRadius='8px';
                div.style.webkitBorderTopRightRadius='8px';
                div.style.mozBorderRadiusTopright='8px';
                div.style.borderTopRightRadius='8px';
                div.style.webkitBorderBottomLeftRadius='8px';
                div.style.mozBorderRadiusBottomleft='8px';
                div.style.borderBottomLeftRadius='8px';
                div.style.webkitBorderBottomRightRadius='8px';
                div.style.mozBorderRadiusBottomright='8px';
                div.style.borderBottomRightRadius='8px';
                div.style.mozBoxShadow='0px 10px 14px -7px #276873';
                div.style.webkitBoxShadow='0px 10px 14px -7px #276873';
                div.style.boxShadow='0px 10px 14px -7px #276873';
                div.style.textAlign='center';
                div.style.display='inline-block';
                div.style.textDecoration='none';
                map.getContainer().appendChild(div);
                return div;
            };
            var myZoomCtrl = new ZoomControl();
            map.addControl(myZoomCtrl);
            function ZoomControl1(){
                this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
                this.defaultOffset = new BMap.Size(60, 0);
            }
            ZoomControl1.prototype = new BMap.Control();
            ZoomControl1.prototype.initialize = function(map) {
                var div1 = document.createElement("button");
                div1.appendChild(document.createTextNode("减少"));
                div1.style.cursor = "pointer";
                div1.style.border = "0px solid #dcdcdc";
                div1.style.backgroundColor = "white";
                div1.id="decrease";
                div1.style.fontSize="1rem";
                div1.style.lineHeight="1.5rem";
                div1.style.backgroundColor='#ededed';
                div1.style.color="#ffffff";
                div1.style.fontWeight="bold";
                div1.style.fontFamily="Arial";
                div1.style.background="-webkit-gradient(linear, left top, left bottom, color-start(0.05, #599bb3), color-stop(1, #408c99))";
                div1.style.background='-moz-linear-gradient(top, #599bb3 5%, #408c99 100%)';
                div1.style.background='-o-linear-gradient(top, #599bb3 5%, #408c99 100%)';
                div1.style.background='-ms-linear-gradient(top, #599bb3 5%, #408c99 100%)';
                div1.style.background='linear-gradient(to bottom, #599bb3 5%, #408c99 100%)';
                div1.style.background='-webkit-linear-gradient(top, #599bb3 5%, #408c99 100%)';
                div1.style.filter="'progid:DXImageTransform.Microsoft.gradient(startColorstr='#599bb3', endColorstr='#408c99',GradientType=0)'";
                div1.style.webkitBorderTopLeftRadius='8px';
                div1.style.mozBorderRadiusTopleft='8px';
                div1.style.borderTopLeftRadius='8px';
                div1.style.webkitBorderTopRightRadius='8px';
                div1.style.mozBorderRadiusTopright='8px';
                div1.style.borderTopRightRadius='8px';
                div1.style.webkitBorderBottomLeftRadius='8px';
                div1.style.mozBorderRadiusBottomleft='8px';
                div1.style.borderBottomLeftRadius='8px';
                div1.style.webkitBorderBottomRightRadius='8px';
                div1.style.mozBorderRadiusBottomright='8px';
                div1.style.borderBottomRightRadius='8px';
                div1.style.mozBoxShadow='0px 10px 14px -7px #276873';
                div1.style.webkitBoxShadow='0px 10px 14px -7px #276873';
                div1.style.boxShadow='0px 10px 14px -7px #276873';
                div1.style.textAlign='center';
                div1.style.display='inline-block';
                div1.style.textDecoration='none';
                map.getContainer().appendChild(div1);
                return div1;
            };
            var myZoomCtrl1 = new ZoomControl1();
            map.addControl(myZoomCtrl1);
            function ZoomControl2(){
                this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
                this.defaultOffset = new BMap.Size(120, 0);
            }
            ZoomControl2.prototype = new BMap.Control();
            ZoomControl2.prototype.initialize = function(map) {
                var div2 = document.createElement("button");
                div2.appendChild(document.createTextNode("提交"));
                div2.style.cursor = "pointer";
                div2.style.border = "0px solid #dcdcdc";
                div2.style.backgroundColor = "white";
                div2.style.fontSize="1rem";
                div2.id='submit';
                div2.style.lineHeight="1.5rem";
                div2.style.fontSize="1rem";
                div2.style.lineHeight="1.5rem";
                div2.style.backgroundColor='#ededed';
                div2.style.color="#ffffff";
                div2.style.fontWeight="bold";
                div2.style.fontFamily="Arial";
                div2.style.background="-webkit-gradient(linear, left top, left bottom, color-start(0.05, #599bb3), color-stop(1, #408c99))";
                div2.style.background='-moz-linear-gradient(top, #599bb3 5%, #408c99 100%)';
                div2.style.background='-o-linear-gradient(top, #599bb3 5%, #408c99 100%)';
                div2.style.background='-ms-linear-gradient(top, #599bb3 5%, #408c99 100%)';
                div2.style.background='linear-gradient(to bottom, #599bb3 5%, #408c99 100%)';
                div2.style.background='-webkit-linear-gradient(top, #599bb3 5%, #408c99 100%)';
                div2.style.filter="'progid:DXImageTransform.Microsoft.gradient(startColorstr='#599bb3', endColorstr='#408c99',GradientType=0)'";
                div2.style.webkitBorderTopLeftRadius='8px';
                div2.style.mozBorderRadiusTopleft='8px';
                div2.style.borderTopLeftRadius='8px';
                div2.style.webkitBorderTopRightRadius='8px';
                div2.style.mozBorderRadiusTopright='8px';
                div2.style.borderTopRightRadius='8px';
                div2.style.webkitBorderBottomLeftRadius='8px';
                div2.style.mozBorderRadiusBottomleft='8px';
                div2.style.borderBottomLeftRadius='8px';
                div2.style.webkitBorderBottomRightRadius='8px';
                div2.style.mozBorderRadiusBottomright='8px';
                div2.style.borderBottomRightRadius='8px';
                div2.style.mozBoxShadow='0px 10px 14px -7px #276873';
                div2.style.webkitBoxShadow='0px 10px 14px -7px #276873';
                div2.style.boxShadow='0px 10px 14px -7px #276873';
                div2.style.textAlign='center';
                div2.style.display='inline-block';
                div2.style.textDecoration='none';
                map.getContainer().appendChild(div2);
                return div2;
            };
            var myZoomCtrl2 = new ZoomControl2();
            map.addControl(myZoomCtrl2);
            $(document).ready(function () {
                var index = 500;
                map.addEventListener("click",function(e){
                    longitude = e.point.lng;
                    latitude = e.point.lat;
                    point = new BMap.Point(longitude,latitude);
                    var marker = new BMap.Marker(point, {icon: m1});
                    map.clearOverlays(marker);
                    map.addOverlay(marker);
                    var label = new BMap.Label("半径是:"+index+"米",{offset:new BMap.Size(20,-10)});
                    marker.setLabel(label);
                    var circle = new BMap.Circle(point, index, {strokeColor: "blue", strokeWeight: 2, strokeOpacity: 0.5});
//            map.clearOverlays(circle);
                    map.addOverlay(circle);
                    circle.enableMassClear();
                    map.centerAndZoom(point, ajson.scale);
                });
                var marker = new BMap.Marker(point, {icon: m1});
                map.addOverlay(marker);
                var label = new BMap.Label("半径是:"+index+"米",{offset:new BMap.Size(20,-10)});
                marker.setLabel(label);
                var circle = new BMap.Circle(point, index, {strokeColor: "blue", strokeWeight: 2, strokeOpacity: 0.5});
                map.addOverlay(circle);
                circle.enableMassClear();
                marker.enableDragging();
//        circle.enableEditing();
                $('#decrease').click(function () {
                    if (index > 100 && index <= 1000) {
                        index -= 100;
                    }
                    map.clearOverlays(circle);
                    var circle = new BMap.Circle(point, index, {strokeColor: "blue", strokeWeight: 2, strokeOpacity: 0.5});
                    map.addOverlay(circle);
                    var marker = new BMap.Marker(point, {icon: m1});
                    var label = new BMap.Label("半径是:"+index+"米",{offset:new BMap.Size(20,-10)});
                    marker.setLabel(label);
                    map.addOverlay(marker);
                    marker.enableDragging();
//            circle.enableEditing();
                });
                $('#plus').click(function () {
                    if (index >= 0 && index <= 900) {
                        index += 100;
                    }
                    map.clearOverlays(circle);
                    var circle = new BMap.Circle(point, index, {strokeColor: "blue", strokeWeight: 2, strokeOpacity: 0.5});
                    map.addOverlay(circle);
                    var marker = new BMap.Marker(point, {icon: m1});
                    var label = new BMap.Label("半径是:"+index+"米",{offset:new BMap.Size(20,-10)});
                    marker.setLabel(label);
                    map.addOverlay(marker);
                    marker.enableDragging();
//            circle.enableEditing();
                });
                $("#submit").click(function(){
                    $.ajax({
                        url:'GetCoords.json',
                        type:"GET",
                        data:$('#form').serialize(),
                        success: function(data) {
                            $("#result").text(data);
                        }
                    });
                });
                var navigationControl = new BMap.NavigationControl({
                    anchor: BMAP_ANCHOR_BOTTOM_RIGHT,
                    type: BMAP_NAVIGATION_CONTROL_LARGE,
                    enableGeolocation: true
                });
                map.addControl(navigationControl);
                var geolocationControl = new BMap.GeolocationControl();
                geolocationControl.addEventListener("locationSuccess", function (e) {
                    var address = '';
                    address += e.addressComponent.province;
                    address += e.addressComponent.city;
                    address += e.addressComponent.district;
                    address += e.addressComponent.street;
                    address += e.addressComponent.streetNumber;
                    alert("当前定位地址为：" + address);
                });
                geolocationControl.addEventListener("locationError", function (e) {
                    alert(e.message);
                });
                map.addControl(geolocationControl);
                map.enableScrollWheelZoom(true);
            });
        }
    });

</script>